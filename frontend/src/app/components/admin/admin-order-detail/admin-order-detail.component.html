<div class="order-detail-container">
  <div class="header-actions">
    <button mat-raised-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Back to Orders
    </button>
    <div class="action-buttons">
      <button mat-raised-button color="primary" (click)="toggleEditMode()" *ngIf="!editMode">
        <mat-icon>edit</mat-icon>
        Edit Order
      </button>
      <button mat-raised-button color="warn" (click)="deleteOrder()" *ngIf="!editMode">
        <mat-icon>delete</mat-icon>
        Delete
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="!loading && order" class="content">
    <mat-tab-group>
      <!-- Order Details Tab -->
      <mat-tab label="Order Details">
        <div class="tab-content">
          <mat-card *ngIf="!editMode" class="info-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>info</mat-icon>
                Order Information
              </mat-card-title>
              <div class="header-chips">
                <mat-chip [color]="getStatusColor(order.status)">
                  {{ order.status }}
                </mat-chip>
                <mat-chip [color]="getPriorityColor(order.priority)">
                  {{ order.priority }}
                </mat-chip>
              </div>
            </mat-card-header>
            <mat-card-content>
              <div class="info-grid">
                <div class="info-row">
                  <strong>Order Number:</strong>
                  <span>{{ order.orderNumber }}</span>
                </div>
                <div class="info-row">
                  <strong>Service Type:</strong>
                  <span>{{ order.serviceType }}</span>
                </div>
                <div class="info-row">
                  <strong>Customer Name:</strong>
                  <span>{{ order.customerName }}</span>
                </div>
                <div class="info-row">
                  <strong>Phone:</strong>
                  <span>{{ order.customerPhone }}</span>
                </div>
                <div class="info-row" *ngIf="order.customerEmail">
                  <strong>Email:</strong>
                  <span>{{ order.customerEmail }}</span>
                </div>
                <div class="info-row">
                  <strong>Address:</strong>
                  <span>{{ order.customerAddress }}</span>
                </div>
                <div class="info-row" *ngIf="order.scheduledDate">
                  <strong>Scheduled Date:</strong>
                  <span>{{ formatDate(order.scheduledDate) }}</span>
                </div>
                <div class="info-row" *ngIf="order.description">
                  <strong>Description:</strong>
                  <span>{{ order.description }}</span>
                </div>
                <div class="info-row" *ngIf="order.notes">
                  <strong>Notes:</strong>
                  <span>{{ order.notes }}</span>
                </div>
              </div>
              
              <!-- Google Map Display -->
              <div class="map-section" *ngIf="order.latitude && order.longitude">
                <h3>
                  <mat-icon>location_on</mat-icon>
                  Service Location
                </h3>
                <app-google-map 
                  [latitude]="order.latitude" 
                  [longitude]="order.longitude"
                  [address]="order.customerAddress"
                  [zoom]="15">
                </app-google-map>
                <div class="map-actions">
                  <a [href]="'https://www.google.com/maps/dir/?api=1&destination=' + order.latitude + ',' + order.longitude" 
                     target="_blank" 
                     mat-raised-button color="primary">
                    <mat-icon>directions</mat-icon>
                    Get Directions
                  </a>
                  <button mat-raised-button (click)="copyLocation()">
                    <mat-icon>content_copy</mat-icon>
                    Copy Location
                  </button>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Edit Form -->
          <mat-card *ngIf="editMode" class="edit-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>edit</mat-icon>
                Edit Order
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <form [formGroup]="orderForm" (ngSubmit)="updateOrder()">
                <div class="form-grid">
                  <mat-form-field appearance="outline">
                    <mat-label>Customer Name</mat-label>
                    <input matInput formControlName="customerName" required>
                    <mat-icon matPrefix>person</mat-icon>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Phone</mat-label>
                    <input matInput formControlName="customerPhone" required>
                    <mat-icon matPrefix>phone</mat-icon>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Email</mat-label>
                    <input matInput formControlName="customerEmail" type="email">
                    <mat-icon matPrefix>email</mat-icon>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Address</mat-label>
                    <textarea matInput formControlName="customerAddress" rows="2" required></textarea>
                    <mat-icon matPrefix>location_on</mat-icon>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Latitude</mat-label>
                    <input matInput formControlName="latitude" type="number" step="any">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Longitude</mat-label>
                    <input matInput formControlName="longitude" type="number" step="any">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Service Type</mat-label>
                    <mat-select formControlName="serviceType" required>
                      <mat-option *ngFor="let type of serviceTypes" [value]="type">
                        {{ type }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Priority</mat-label>
                    <mat-select formControlName="priority" required>
                      <mat-option *ngFor="let priority of priorities" [value]="priority">
                        {{ priority | titlecase }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Status</mat-label>
                    <mat-select formControlName="status" required>
                      <mat-option *ngFor="let status of statusOptions" [value]="status.value">
                        {{ status.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Scheduled Date</mat-label>
                    <input matInput [matDatepicker]="picker" formControlName="scheduledDate">
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Description</mat-label>
                    <textarea matInput formControlName="description" rows="3"></textarea>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Notes</mat-label>
                    <textarea matInput formControlName="notes" rows="3"></textarea>
                  </mat-form-field>
                </div>

                <div class="button-group">
                  <button mat-raised-button color="primary" type="submit" [disabled]="loading || orderForm.invalid">
                    <mat-icon>save</mat-icon>
                    Save Changes
                  </button>
                  <button mat-button type="button" (click)="toggleEditMode()">
                    Cancel
                  </button>
                </div>
              </form>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Assignment Tab -->
      <mat-tab label="Assignment">
        <div class="tab-content">
          <mat-card class="assign-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>assignment_ind</mat-icon>
                Employee Assignment
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="current-assignment" *ngIf="order.assignedTo">
                <h3>Currently Assigned To:</h3>
                <div class="employee-info">
                  <mat-icon>person</mat-icon>
                  <div>
                    <strong>{{ order.assignedTo.name }}</strong>
                    <small>{{ order.assignedTo.email }}</small>
                  </div>
                </div>
              </div>

              <div class="assign-form">
                <h3>{{ order.assignedTo ? 'Reassign to Another Employee' : 'Assign Employee' }}</h3>
                <form [formGroup]="assignForm" (ngSubmit)="assignEmployee()">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Select Employee</mat-label>
                    <mat-select formControlName="assignedToId" required>
                      <mat-option *ngFor="let employee of employees" [value]="employee.id">
                        {{ employee.name }} ({{ employee.email }})
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <button mat-raised-button color="primary" type="submit" [disabled]="loading || assignForm.invalid">
                    <mat-icon>assignment_turned_in</mat-icon>
                    {{ order.assignedTo ? 'Reassign' : 'Assign' }} Employee
                  </button>
                </form>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Order History Tab -->
      <mat-tab label="Order History">
        <div class="tab-content">
          <mat-card class="history-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>history</mat-icon>
                Order History
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="order.history && order.history.length > 0" class="timeline">
                <div class="timeline-item" *ngFor="let history of order.history">
                  <div class="timeline-marker"></div>
                  <div class="timeline-content">
                    <div class="timeline-header">
                      <strong>{{ history.action }}</strong>
                      <span class="timeline-date">{{ formatDate(history.createdAt) }}</span>
                    </div>
                    <div class="timeline-details" *ngIf="history.oldStatus || history.newStatus">
                      <mat-chip *ngIf="history.oldStatus" [color]="getStatusColor(history.oldStatus)" class="small-chip">
                        {{ history.oldStatus }}
                      </mat-chip>
                      <mat-icon *ngIf="history.oldStatus && history.newStatus">arrow_forward</mat-icon>
                      <mat-chip *ngIf="history.newStatus" [color]="getStatusColor(history.newStatus)" class="small-chip">
                        {{ history.newStatus }}
                      </mat-chip>
                    </div>
                    <div class="timeline-notes" *ngIf="history.notes">
                      {{ history.notes }}
                    </div>
                    <div class="timeline-user" *ngIf="history.user">
                      By: {{ history.user.name }} ({{ history.user.role }})
                    </div>
                  </div>
                </div>
              </div>
              <div *ngIf="!order.history || order.history.length === 0" class="no-history">
                <mat-icon>inbox</mat-icon>
                <p>No history available for this order</p>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>
