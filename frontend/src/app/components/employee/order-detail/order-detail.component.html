<div class="order-detail-container">
  <div class="header-actions">
    <button mat-raised-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Back to Orders
    </button>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="!loading && order" class="content-grid">
    <!-- Order Information Card -->
    <mat-card class="info-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>info</mat-icon>
          Order Information
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-row">
          <strong>Order ID:</strong>
          <span>#{{ order.id }}</span>
        </div>
        <div class="info-row">
          <strong>Service Type:</strong>
          <span>{{ order.serviceType }}</span>
        </div>
        <div class="info-row">
          <strong>Current Status:</strong>
          <mat-chip [color]="getStatusColor(order.status)">
            {{ order.status }}
          </mat-chip>
        </div>
        <div class="info-row">
          <strong>Priority:</strong>
          <mat-chip [color]="getPriorityColor(order.priority)">
            {{ order.priority }}
          </mat-chip>
        </div>
        <div class="info-row">
          <strong>Scheduled Date:</strong>
          <span>{{ formatDate(order.scheduledDate) }}</span>
        </div>
        <div class="info-row" *ngIf="order.description">
          <strong>Description:</strong>
          <span>{{ order.description }}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Customer Information Card -->
    <mat-card class="info-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>person</mat-icon>
          Customer Information
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-row">
          <strong>Name:</strong>
          <span>{{ order.customerName }}</span>
        </div>
        <div class="info-row">
          <strong>Phone:</strong>
          <span>{{ order.customerPhone }}</span>
        </div>
        <div class="info-row" *ngIf="order.customerEmail">
          <strong>Email:</strong>
          <span>{{ order.customerEmail }}</span>
        </div>
        <div class="info-row">
          <strong>Address:</strong>
          <span>{{ order.customerAddress }}</span>
        </div>
        <div class="info-row" *ngIf="order.latitude && order.longitude">
          <strong>Location:</strong>
          <a [href]="'https://www.google.com/maps?q=' + order.latitude + ',' + order.longitude" 
             target="_blank" 
             class="map-link">
            <mat-icon>location_on</mat-icon>
            View on Map
          </a>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Update Status Card -->
    <mat-card class="update-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>edit</mat-icon>
          Update Order Status
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="statusForm" (ngSubmit)="updateStatus()">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status" required>
              <mat-option *ngFor="let status of statusOptions" [value]="status.value">
                <mat-icon>{{ status.icon }}</mat-icon>
                {{ status.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Notes (Optional)</mat-label>
            <textarea 
              matInput 
              formControlName="notes" 
              rows="4"
              placeholder="Add notes about this status update..."></textarea>
          </mat-form-field>

          <div class="button-group">
            <button 
              mat-raised-button 
              color="primary" 
              type="submit"
              [disabled]="loading || statusForm.invalid">
              <mat-icon>save</mat-icon>
              Update Status
            </button>
            <button 
              mat-button 
              type="button" 
              (click)="goBack()">
              Cancel
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Order History Card -->
    <mat-card class="history-card" *ngIf="order.orderHistory && order.orderHistory.length > 0">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>history</mat-icon>
          Order History
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="timeline">
          <div class="timeline-item" *ngFor="let history of order.orderHistory">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <div class="timeline-header">
                <mat-chip [color]="getStatusColor(history.status)" class="status-chip">
                  {{ history.status }}
                </mat-chip>
                <span class="timeline-date">{{ formatDate(history.createdAt) }}</span>
              </div>
              <div class="timeline-notes" *ngIf="history.notes">
                {{ history.notes }}
              </div>
              <div class="timeline-user" *ngIf="history.user">
                Updated by: {{ history.user.name }}
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
